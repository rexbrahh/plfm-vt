openapi: 3.1.0
info:
  title: TRC Control Plane API
  version: "v1"
  description: |
    Control plane HTTP API.

    Key properties:
    - Org-scoped paths for tenant resources.
    - Append-only event log as source of truth, materialized views for reads.
    - Workloads run as Firecracker microVM instances on hosts.
    - Ingress is L4-first (TLS SNI passthrough by default).

servers:
  - url: /v1

tags:
  - name: Auth
  - name: Orgs
  - name: Projects
  - name: Members
  - name: Apps
  - name: Envs
  - name: Releases
  - name: Deploys
  - name: Scale
  - name: Instances
  - name: Routes
  - name: Secrets
  - name: Volumes
  - name: Logs
  - name: Exec
  - name: Events

security:
  - bearerAuth: []

paths:
  /auth/device/start:
    post:
      tags: [Auth]
      summary: Start device authorization
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DeviceStartRequest"
      responses:
        "200":
          description: Device authorization created
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeviceStartResponse"
        "400":
          $ref: "#/components/responses/Error400"

  /auth/device/token:
    post:
      tags: [Auth]
      summary: Poll device authorization token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DeviceTokenRequest"
      responses:
        "200":
          description: Tokens issued
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeviceTokenResponse"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "429":
          $ref: "#/components/responses/Error429"

  /auth/token:
    post:
      tags: [Auth]
      summary: Mint an access token (client credentials)
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TokenRequest"
      responses:
        "200":
          description: Access token minted
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "429":
          $ref: "#/components/responses/Error429"

  /auth/token/refresh:
    post:
      tags: [Auth]
      summary: Refresh an access token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshTokenRequest"
      responses:
        "200":
          description: Access token refreshed (and optionally refresh token rotated)
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RefreshTokenResponse"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "429":
          $ref: "#/components/responses/Error429"

  /auth/token/revoke:
    post:
      tags: [Auth]
      summary: Revoke a token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RevokeTokenRequest"
      responses:
        "200":
          description: Revoked (idempotent)
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RevokeTokenResponse"
        "400":
          $ref: "#/components/responses/Error400"
        "429":
          $ref: "#/components/responses/Error429"

  /auth/whoami:
    get:
      tags: [Auth]
      summary: Return token subject identity and org memberships
      responses:
        "200":
          description: Identity
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WhoAmIResponse"
        "401":
          $ref: "#/components/responses/Error401"

  /orgs:
    get:
      tags: [Orgs]
      summary: List orgs the caller belongs to
      responses:
        "200":
          description: Orgs
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListOrgsResponse"
        "401":
          $ref: "#/components/responses/Error401"
    post:
      tags: [Orgs]
      summary: Create org
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateOrgRequest"
      responses:
        "200":
          description: Org created
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Org"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}:
    get:
      tags: [Orgs]
      summary: Get an org
      parameters:
        - $ref: "#/components/parameters/OrgId"
      responses:
        "200":
          description: Org
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Org"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
    patch:
      tags: [Orgs]
      summary: Update org
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateOrgRequest"
      responses:
        "200":
          description: Org updated
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Org"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}/projects:
    get:
      tags: [Projects]
      summary: List projects
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Cursor"
      responses:
        "200":
          description: Projects
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListProjectsResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
    post:
      tags: [Projects]
      summary: Create project
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateProjectRequest"
      responses:
        "200":
          description: Project created
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}/projects/{project_id}:
    get:
      tags: [Projects]
      summary: Get project
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/ProjectId"
      responses:
        "200":
          description: Project
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
    patch:
      tags: [Projects]
      summary: Update project
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/ProjectId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateProjectRequest"
      responses:
        "200":
          description: Project updated
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}/members:
    get:
      tags: [Members]
      summary: List org members
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Cursor"
      responses:
        "200":
          description: Members
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListMembersResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
    post:
      tags: [Members]
      summary: Add org member
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateMemberRequest"
      responses:
        "200":
          description: Member created
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Member"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}/members/{member_id}:
    patch:
      tags: [Members]
      summary: Update org member
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/MemberId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateMemberRequest"
      responses:
        "200":
          description: Member updated
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Member"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
        "409":
          $ref: "#/components/responses/Error409"
    delete:
      tags: [Members]
      summary: Remove org member
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/MemberId"
      responses:
        "200":
          description: Removed (idempotent)
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /orgs/{org_id}/apps:
    get:
      tags: [Apps]
      summary: List apps
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Cursor"
      responses:
        "200":
          description: Apps
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListAppsResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
    post:
      tags: [Apps]
      summary: Create app
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateAppRequest"
      responses:
        "200":
          description: App created
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/App"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}/apps/{app_id}:
    get:
      tags: [Apps]
      summary: Get app
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
      responses:
        "200":
          description: App
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/App"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
    patch:
      tags: [Apps]
      summary: Update app
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateAppRequest"
      responses:
        "200":
          description: App updated
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/App"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
        "409":
          $ref: "#/components/responses/Error409"
    delete:
      tags: [Apps]
      summary: Delete app
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
      responses:
        "200":
          description: Deleted (idempotent)
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /orgs/{org_id}/apps/{app_id}/envs:
    get:
      tags: [Envs]
      summary: List environments
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Cursor"
      responses:
        "200":
          description: Envs
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListEnvsResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
    post:
      tags: [Envs]
      summary: Create environment
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateEnvRequest"
      responses:
        "200":
          description: Env created
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Env"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}/apps/{app_id}/envs/{env_id}:
    get:
      tags: [Envs]
      summary: Get environment
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
      responses:
        "200":
          description: Env
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Env"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
    patch:
      tags: [Envs]
      summary: Update environment
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateEnvRequest"
      responses:
        "200":
          description: Env updated
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Env"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
        "409":
          $ref: "#/components/responses/Error409"
    delete:
      tags: [Envs]
      summary: Delete environment
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
      responses:
        "200":
          description: Deleted (idempotent)
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /orgs/{org_id}/apps/{app_id}/releases:
    get:
      tags: [Releases]
      summary: List releases
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Cursor"
      responses:
        "200":
          description: Releases
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListReleasesResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
    post:
      tags: [Releases]
      summary: Create release (image ref + manifest)
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateReleaseRequest"
      responses:
        "200":
          description: Release created
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Release"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}/apps/{app_id}/releases/{release_id}:
    get:
      tags: [Releases]
      summary: Get release
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/ReleaseId"
      responses:
        "200":
          description: Release
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Release"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /orgs/{org_id}/apps/{app_id}/envs/{env_id}/deploys:
    get:
      tags: [Deploys]
      summary: List deploys
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Cursor"
      responses:
        "200":
          description: Deploys
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListDeploysResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
    post:
      tags: [Deploys]
      summary: Create deploy (promote a release into an env)
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateDeployRequest"
      responses:
        "200":
          description: Deploy created
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Deploy"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}/apps/{app_id}/envs/{env_id}/deploys/{deploy_id}:
    get:
      tags: [Deploys]
      summary: Get deploy
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/DeployId"
      responses:
        "200":
          description: Deploy
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Deploy"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /orgs/{org_id}/apps/{app_id}/envs/{env_id}/rollbacks:
    post:
      tags: [Deploys]
      summary: Create rollback (select a previous release)
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RollbackRequest"
      responses:
        "200":
          description: Rollback started (represented as a deploy)
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Deploy"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}/apps/{app_id}/envs/{env_id}/scale:
    get:
      tags: [Scale]
      summary: Get desired scale for an env
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
      responses:
        "200":
          description: Scale state
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScaleState"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
    put:
      tags: [Scale]
      summary: Set desired scale for an env
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ScaleUpdateRequest"
      responses:
        "200":
          description: Updated scale state
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScaleState"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}/apps/{app_id}/envs/{env_id}/instances:
    get:
      tags: [Instances]
      summary: List instances in an env
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/ProcessTypeQuery"
        - $ref: "#/components/parameters/InstanceStatusQuery"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Cursor"
      responses:
        "200":
          description: Instances
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListInstancesResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /orgs/{org_id}/apps/{app_id}/envs/{env_id}/instances/{instance_id}:
    get:
      tags: [Instances]
      summary: Get instance
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/InstanceId"
      responses:
        "200":
          description: Instance
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Instance"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /orgs/{org_id}/apps/{app_id}/envs/{env_id}/routes:
    get:
      tags: [Routes]
      summary: List routes for an env
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Cursor"
      responses:
        "200":
          description: Routes
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListRoutesResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
    post:
      tags: [Routes]
      summary: Create route
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateRouteRequest"
      responses:
        "200":
          description: Route created
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Route"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}/apps/{app_id}/envs/{env_id}/routes/{route_id}:
    get:
      tags: [Routes]
      summary: Get route
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/RouteId"
      responses:
        "200":
          description: Route
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Route"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
    patch:
      tags: [Routes]
      summary: Update route
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/RouteId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateRouteRequest"
      responses:
        "200":
          description: Route updated
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Route"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
        "409":
          $ref: "#/components/responses/Error409"
    delete:
      tags: [Routes]
      summary: Delete route
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/RouteId"
      responses:
        "200":
          description: Deleted (idempotent)
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /orgs/{org_id}/apps/{app_id}/envs/{env_id}/secrets:
    get:
      tags: [Secrets]
      summary: Get secrets metadata (bundle id and current version)
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
      responses:
        "200":
          description: Secrets metadata
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SecretsMetadata"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
    put:
      tags: [Secrets]
      summary: Set secrets (creates a new version)
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PutSecretsRequest"
      responses:
        "200":
          description: New secrets version metadata
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SecretsMetadata"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}/volumes:
    get:
      tags: [Volumes]
      summary: List volumes (org scoped)
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Cursor"
      responses:
        "200":
          description: Volumes
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListVolumesResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
    post:
      tags: [Volumes]
      summary: Create volume
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateVolumeRequest"
      responses:
        "200":
          description: Volume created
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Volume"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}/volumes/{volume_id}:
    get:
      tags: [Volumes]
      summary: Get volume
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/VolumeId"
      responses:
        "200":
          description: Volume
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Volume"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
    delete:
      tags: [Volumes]
      summary: Delete volume
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/VolumeId"
      responses:
        "200":
          description: Deleted (idempotent)
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /orgs/{org_id}/apps/{app_id}/envs/{env_id}/volume-attachments:
    post:
      tags: [Volumes]
      summary: Attach a volume to an env/process type
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateVolumeAttachmentRequest"
      responses:
        "200":
          description: Attachment created
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VolumeAttachment"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}/apps/{app_id}/envs/{env_id}/volume-attachments/{attachment_id}:
    delete:
      tags: [Volumes]
      summary: Detach a volume attachment
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/AttachmentId"
      responses:
        "200":
          description: Detached (idempotent)
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /orgs/{org_id}/volumes/{volume_id}/snapshots:
    post:
      tags: [Volumes]
      summary: Create snapshot for a volume
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/VolumeId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateSnapshotRequest"
      responses:
        "200":
          description: Snapshot created
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Snapshot"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
    get:
      tags: [Volumes]
      summary: List snapshots for a volume
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/VolumeId"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Cursor"
      responses:
        "200":
          description: Snapshots
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListSnapshotsResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /orgs/{org_id}/volumes/{volume_id}/restore:
    post:
      tags: [Volumes]
      summary: Restore volume from snapshot (creates a new volume)
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/VolumeId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RestoreVolumeRequest"
      responses:
        "200":
          description: New volume created from restore
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Volume"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
        "409":
          $ref: "#/components/responses/Error409"

  /orgs/{org_id}/apps/{app_id}/envs/{env_id}/logs:
    get:
      tags: [Logs]
      summary: Query logs (bounded window)
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/ProcessTypeQuery"
        - $ref: "#/components/parameters/InstanceIdQuery"
        - $ref: "#/components/parameters/SinceQuery"
        - $ref: "#/components/parameters/UntilQuery"
        - $ref: "#/components/parameters/TailLinesQuery"
      responses:
        "200":
          description: Log lines
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LogsResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /orgs/{org_id}/apps/{app_id}/envs/{env_id}/logs/stream:
    get:
      tags: [Logs]
      summary: Stream logs (NDJSON)
      description: |
        Streaming transport is NDJSON (application/x-ndjson) in v1 for simplicity.
        Clients should treat this as a best-effort tail, not an audit log.
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/ProcessTypeQuery"
        - $ref: "#/components/parameters/InstanceIdQuery"
      responses:
        "200":
          description: NDJSON stream of log lines
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/x-ndjson:
              schema:
                type: string
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /orgs/{org_id}/apps/{app_id}/envs/{env_id}/instances/{instance_id}/exec:
    post:
      tags: [Exec]
      summary: Create an exec session grant
      description: |
        This endpoint creates a short-lived exec grant. The response includes a connect URL and a session token.
        Exec is audited and requires explicit permission.
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AppId"
        - $ref: "#/components/parameters/EnvId"
        - $ref: "#/components/parameters/InstanceId"
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExecGrantRequest"
      responses:
        "200":
          description: Exec grant created
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExecGrantResponse"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /orgs/{org_id}/events:
    get:
      tags: [Events]
      summary: Query or tail org-scoped events (debugging)
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AfterEventId"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/EventTypeQuery"
        - $ref: "#/components/parameters/AppIdQuery"
        - $ref: "#/components/parameters/EnvIdQuery"
      responses:
        "200":
          description: Events
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventsResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /orgs/{org_id}/events/stream:
    get:
      tags: [Events]
      summary: Stream org-scoped events (NDJSON)
      description: |
        NDJSON stream of org-scoped events for tailing.
        Event payloads use protobuf JSON mapping when available.
      parameters:
        - $ref: "#/components/parameters/OrgId"
        - $ref: "#/components/parameters/AfterEventId"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/EventTypeQuery"
        - $ref: "#/components/parameters/AppIdQuery"
        - $ref: "#/components/parameters/EnvIdQuery"
        - $ref: "#/components/parameters/PollMsQuery"
      responses:
        "200":
          description: NDJSON stream of events
          headers:
            X-Request-Id:
              $ref: "#/components/headers/XRequestId"
          content:
            application/x-ndjson:
              schema:
                type: string
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
 
  components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: opaque

  headers:
    XRequestId:
      description: Request correlation id
      schema:
        type: string

  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      description: Opaque idempotency key for retry-safe writes
      schema:
        type: string
        minLength: 8
        maxLength: 128

    OrgId:
      name: org_id
      in: path
      required: true
      schema:
        type: string

    ProjectId:
      name: project_id
      in: path
      required: true
      schema:
        type: string

    AppId:
      name: app_id
      in: path
      required: true
      schema:
        type: string

    EnvId:
      name: env_id
      in: path
      required: true
      schema:
        type: string

    ReleaseId:
      name: release_id
      in: path
      required: true
      schema:
        type: string

    DeployId:
      name: deploy_id
      in: path
      required: true
      schema:
        type: string

    RouteId:
      name: route_id
      in: path
      required: true
      schema:
        type: string

    VolumeId:
      name: volume_id
      in: path
      required: true
      schema:
        type: string

    MemberId:
      name: member_id
      in: path
      required: true
      schema:
        type: string

    AttachmentId:
      name: attachment_id
      in: path
      required: true
      schema:
        type: string

    InstanceId:
      name: instance_id
      in: path
      required: true
      schema:
        type: string

    Cursor:
      name: cursor
      in: query
      required: false
      schema:
        type: string

    Limit:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 50

    AfterEventId:
      name: after_event_id
      in: query
      required: false
      schema:
        type: integer
        minimum: 0

    PollMsQuery:
      name: poll_ms
      in: query
      required: false
      schema:
        type: integer
        minimum: 100
        default: 500

    EventTypeQuery:
      name: event_type
      in: query
      required: false
      schema:
        type: string

    AppIdQuery:
      name: app_id
      in: query
      required: false
      schema:
        type: string

    EnvIdQuery:
      name: env_id
      in: query
      required: false
      schema:
        type: string

    ProcessTypeQuery:
      name: process_type
      in: query
      required: false
      schema:
        type: string

    InstanceStatusQuery:
      name: status
      in: query
      required: false
      schema:
        type: string
        enum: [booting, ready, draining, stopped, failed]

    InstanceIdQuery:
      name: instance_id
      in: query
      required: false
      schema:
        type: string

    SinceQuery:
      name: since
      in: query
      required: false
      description: RFC3339 timestamp
      schema:
        type: string

    UntilQuery:
      name: until
      in: query
      required: false
      description: RFC3339 timestamp
      schema:
        type: string

    TailLinesQuery:
      name: tail_lines
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 10000
        default: 200

  responses:
    Error400:
      description: Bad request
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
    Error401:
      description: Unauthorized
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
    Error403:
      description: Forbidden
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
    Error404:
      description: Not found
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
    Error409:
      description: Conflict
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"
    Error429:
      description: Rate limited
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetails"

  schemas:
    ProblemDetails:
      type: object
      required:
        - type
        - title
        - status
        - detail
        - code
        - request_id
        - retryable
        - retry_after_seconds
      properties:
        type:
          type: string
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
        code:
          type: string
        request_id:
          type: string
        retryable:
          type: boolean
        retry_after_seconds:
          type: integer
        details:
          type: array
          items:
            type: object
            required: [field, message]
            properties:
              field:
                type: string
              message:
                type: string

    DeleteResponse:
      type: object
      required: [ok]
      properties:
        ok:
          type: boolean

    Pagination:
      type: object
      required: [items, next_cursor]
      properties:
        items:
          type: array
          items: {}
        next_cursor:
          type: [string, "null"]

    DeviceStartRequest:
      type: object
      required: [client_name]
      properties:
        client_name:
          type: string
          maxLength: 128
        scopes:
          type: array
          items:
            type: string

    DeviceStartResponse:
      type: object
      required:
        - device_code
        - user_code
        - verification_uri
        - expires_in_seconds
        - poll_interval_seconds
      properties:
        device_code:
          type: string
        user_code:
          type: string
        verification_uri:
          type: string
        verification_uri_complete:
          type: string
        expires_in_seconds:
          type: integer
        poll_interval_seconds:
          type: integer

    DeviceTokenRequest:
      type: object
      required: [device_code]
      properties:
        device_code:
          type: string

    DeviceTokenResponse:
      type: object
      required: [access_token, refresh_token, expires_in_seconds]
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        expires_in_seconds:
          type: integer

    TokenRequest:
      type: object
      required: [grant_type, client_id, client_secret]
      properties:
        grant_type:
          type: string
          enum: [client_credentials]
        client_id:
          type: string
        client_secret:
          type: string
        scopes:
          type: array
          items:
            type: string

    TokenResponse:
      type: object
      required: [access_token, expires_in_seconds]
      properties:
        access_token:
          type: string
        expires_in_seconds:
          type: integer

    RefreshTokenRequest:
      type: object
      required: [refresh_token]
      properties:
        refresh_token:
          type: string

    RefreshTokenResponse:
      type: object
      required: [access_token, expires_in_seconds]
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        expires_in_seconds:
          type: integer

    RevokeTokenRequest:
      type: object
      properties:
        refresh_token:
          type: string
        access_token:
          type: string

    RevokeTokenResponse:
      type: object
      required: [ok]
      properties:
        ok:
          type: boolean

    WhoAmIResponse:
      type: object
      required: [subject_type, subject_id, org_memberships, scopes]
      properties:
        subject_type:
          type: string
          enum: [user, service_principal]
        subject_id:
          type: string
        display_name:
          type: string
        org_memberships:
          type: array
          items:
            $ref: "#/components/schemas/OrgMembership"
        scopes:
          type: array
          items:
            type: string

    OrgMembership:
      type: object
      required: [org_id, role]
      properties:
        org_id:
          type: string
        role:
          type: string
          enum: [owner, admin, developer, readonly]

    Org:
      type: object
      required: [id, name, resource_version, created_at, updated_at]
      properties:
        id:
          type: string
        name:
          type: string
        resource_version:
          type: integer
        created_at:
          type: string
        updated_at:
          type: string

    CreateOrgRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string

    UpdateOrgRequest:
      type: object
      required: [expected_version]
      properties:
        name:
          type: string
        expected_version:
          type: integer
          minimum: 0

    Project:
      type: object
      required: [id, org_id, name, created_at, updated_at, resource_version]
      properties:
        id:
          type: string
        org_id:
          type: string
        name:
          type: string
        created_at:
          type: string
        updated_at:
          type: string
        resource_version:
          type: integer

    ListProjectsResponse:
      type: object
      required: [items, next_cursor]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Project"
        next_cursor:
          type: [string, "null"]

    CreateProjectRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string

    UpdateProjectRequest:
      type: object
      required: [expected_version]
      properties:
        name:
          type: string
        expected_version:
          type: integer
          minimum: 0

    ListOrgsResponse:
      type: object
      required: [items, total]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Org"
        total:
          type: integer

    Member:
      type: object
      required: [id, org_id, role, created_at]
      properties:
        id:
          type: string
        org_id:
          type: string
        email:
          type: string
        role:
          type: string
          enum: [owner, admin, developer, readonly]
        created_at:
          type: string
        updated_at:
          type: string
        resource_version:
          type: integer

    ListMembersResponse:
      type: object
      required: [items, next_cursor]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Member"
        next_cursor:
          type: [string, "null"]

    CreateMemberRequest:
      type: object
      required: [email, role]
      properties:
        email:
          type: string
        role:
          type: string
          enum: [owner, admin, developer, readonly]

    UpdateMemberRequest:
      type: object
      required: [role, expected_version]
      properties:
        role:
          type: string
          enum: [owner, admin, developer, readonly]
        expected_version:
          type: integer
          minimum: 0

    App:
      type: object
      required: [id, org_id, name, created_at]
      properties:
        id:
          type: string
        org_id:
          type: string
        name:
          type: string
        description:
          type: string
        created_at:
          type: string
        updated_at:
          type: string
        resource_version:
          type: integer

    ListAppsResponse:
      type: object
      required: [items, next_cursor]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/App"
        next_cursor:
          type: [string, "null"]

    CreateAppRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        description:
          type: string

    UpdateAppRequest:
      type: object
      required: [expected_version]
      properties:
        name:
          type: string
        description:
          type: string
        expected_version:
          type: integer
          minimum: 0

    Env:
      type: object
      required: [id, app_id, name, created_at]
      properties:
        id:
          type: string
        app_id:
          type: string
        name:
          type: string
        created_at:
          type: string
        updated_at:
          type: string
        resource_version:
          type: integer

    ListEnvsResponse:
      type: object
      required: [items, next_cursor]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Env"
        next_cursor:
          type: [string, "null"]

    CreateEnvRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string

    UpdateEnvRequest:
      type: object
      required: [expected_version]
      properties:
        name:
          type: string
        expected_version:
          type: integer
          minimum: 0

    Release:
      type: object
      required:
        [
          id,
          org_id,
          app_id,
          image_ref,
          image_digest,
          manifest_schema_version,
          manifest_hash,
          command,
          resource_version,
          created_at,
        ]
      properties:
        id:
          type: string
        org_id:
          type: string
        app_id:
          type: string
        image_ref:
          type: string
        image_digest:
          type: string
        manifest_hash:
          type: string
        manifest_schema_version:
          type: integer
        command:
          type: array
          items:
            type: string
          minItems: 1
        resource_version:
          type: integer
        created_at:
          type: string

    ReleaseImage:
      type: object
      required: [index_or_manifest_digest]
      properties:
        image_ref:
          type: string
        index_or_manifest_digest:
          type: string
        resolved_digests:
          type: array
          items:
            $ref: "#/components/schemas/ResolvedImageDigest"

    ResolvedImageDigest:
      type: object
      required: [os, arch, digest]
      properties:
        os:
          type: string
        arch:
          type: string
        digest:
          type: string

    CreateReleaseRequest:
      type: object
      required: [image_ref, image_digest, manifest_hash, command]
      properties:
        image_ref:
          type: string
          description: OCI reference (must be pinned by digest in v1)
        image_digest:
          type: string
          description: Image digest (sha256:...)
        manifest_schema_version:
          type: integer
          default: 1
        manifest_hash:
          type: string
          description: Hash of manifest content (sha256:...)
        command:
          type: array
          items:
            type: string
          minItems: 1
          description: Fully resolved entrypoint command

    ListReleasesResponse:
      type: object
      required: [items, next_cursor]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Release"
        next_cursor:
          type: [string, "null"]

    Deploy:
      type: object
      required:
        [
          id,
          org_id,
          app_id,
          env_id,
          kind,
          release_id,
          process_types,
          status,
          resource_version,
          created_at,
          updated_at,
        ]
      properties:
        id:
          type: string
        org_id:
          type: string
        app_id:
          type: string
        env_id:
          type: string
        kind:
          type: string
          enum: [deploy, rollback]
        release_id:
          type: string
        process_types:
          type: array
          items:
            type: string
        status:
          type: string
          enum: [queued, rolling, succeeded, failed]
        message:
          type: [string, "null"]
        resource_version:
          type: integer
        created_at:
          type: string
        updated_at:
          type: string

    CreateDeployRequest:
      type: object
      required: [release_id]
      properties:
        release_id:
          type: string
        process_types:
          type: array
          items:
            type: string
        strategy:
          type: string
          enum: [rolling]
          default: rolling

    RollbackRequest:
      type: object
      required: [release_id]
      properties:
        release_id:
          type: string

    ListDeploysResponse:
      type: object
      required: [items, next_cursor]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Deploy"
        next_cursor:
          type: [string, "null"]

    ScaleState:
      type: object
      required: [env_id, processes, updated_at]
      properties:
        env_id:
          type: string
        processes:
          type: array
          items:
            $ref: "#/components/schemas/ProcessScale"
        updated_at:
          type: string
        resource_version:
          type: integer

    ProcessScale:
      type: object
      required: [process_type, desired]
      properties:
        process_type:
          type: string
        desired:
          type: integer
          minimum: 0

    ScaleUpdateRequest:
      type: object
      required: [processes, expected_version]
      properties:
        processes:
          type: array
          items:
            $ref: "#/components/schemas/ProcessScale"
        expected_version:
          type: integer
          minimum: 0

    Instance:
      type: object
      required: [id, env_id, process_type, status, created_at]
      properties:
        id:
          type: string
        env_id:
          type: string
        process_type:
          type: string
        node_id:
          type: string
        generation:
          type: integer
        status:
          type: string
          enum: [booting, ready, draining, stopped, failed]
        last_transition_at:
          type: string
        failure_reason:
          type: string
        created_at:
          type: string

    ListInstancesResponse:
      type: object
      required: [items, next_cursor]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Instance"
        next_cursor:
          type: [string, "null"]

    Route:
      type: object
      required:
        - id
        - env_id
        - hostname
        - listen_port
        - protocol_hint
        - backend_process_type
        - backend_port
        - proxy_protocol
        - created_at
      properties:
        id:
          type: string
        env_id:
          type: string
        hostname:
          type: string
        listen_port:
          type: integer
          minimum: 1
          maximum: 65535
        protocol_hint:
          type: string
          enum: [tls_passthrough, tcp_raw]
        backend_process_type:
          type: string
        backend_port:
          type: integer
          minimum: 1
          maximum: 65535
        proxy_protocol:
          type: string
          enum: [off, v2]
        ipv4_required:
          type: boolean
          default: false
        created_at:
          type: string
        updated_at:
          type: string
        resource_version:
          type: integer

    ListRoutesResponse:
      type: object
      required: [items, next_cursor]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Route"
        next_cursor:
          type: [string, "null"]

    CreateRouteRequest:
      type: object
      required:
        [
          hostname,
          listen_port,
          protocol_hint,
          backend_process_type,
          backend_port,
        ]
      properties:
        hostname:
          type: string
        listen_port:
          type: integer
          minimum: 1
          maximum: 65535
        protocol_hint:
          type: string
          enum: [tls_passthrough, tcp_raw]
        backend_process_type:
          type: string
        backend_port:
          type: integer
          minimum: 1
          maximum: 65535
        proxy_protocol:
          type: string
          enum: [off, v2]
          default: off
        backend_expects_proxy_protocol:
          type: boolean
          default: false
        ipv4_required:
          type: boolean
          default: false

    UpdateRouteRequest:
      type: object
      required: [expected_version]
      properties:
        expected_version:
          type: integer
          minimum: 0
        backend_process_type:
          type: string
        backend_port:
          type: integer
          minimum: 1
          maximum: 65535
        proxy_protocol:
          type: string
          enum: [off, v2]
        backend_expects_proxy_protocol:
          type: boolean
        ipv4_required:
          type: boolean

    SecretsMetadata:
      type: object
      required: [env_id, bundle_id, current_version_id, updated_at]
      properties:
        env_id:
          type: string
        bundle_id:
          type: string
        current_version_id:
          type: string
        updated_at:
          type: string

    PutSecretsRequest:
      oneOf:
        - $ref: "#/components/schemas/PutSecretsEnvFileRequest"
        - $ref: "#/components/schemas/PutSecretsMapRequest"

    PutSecretsEnvFileRequest:
      type: object
      required: [format, data]
      properties:
        format:
          type: string
          enum: [platform_env_v1]
        data:
          type: string
          description: Raw secrets file content in platform format

    PutSecretsMapRequest:
      type: object
      required: [values]
      properties:
        values:
          type: object
          additionalProperties:
            type: string

    Volume:
      type: object
      required: [id, org_id, size_bytes, filesystem, created_at]
      properties:
        id:
          type: string
        org_id:
          type: string
        name:
          type: string
        size_bytes:
          type: integer
          minimum: 1
        filesystem:
          type: string
          enum: [ext4]
        created_at:
          type: string
        updated_at:
          type: string
        attachments:
          type: array
          items:
            $ref: "#/components/schemas/VolumeAttachment"

    ListVolumesResponse:
      type: object
      required: [items, next_cursor]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Volume"
        next_cursor:
          type: [string, "null"]

    CreateVolumeRequest:
      type: object
      required: [size_bytes]
      properties:
        name:
          type: string
        size_bytes:
          type: integer
          minimum: 1073741824
        filesystem:
          type: string
          enum: [ext4]
          default: ext4
        backup_enabled:
          type: boolean
          default: true

    VolumeAttachment:
      type: object
      required: [id, volume_id, env_id, process_type, mount_path, created_at]
      properties:
        id:
          type: string
        volume_id:
          type: string
        env_id:
          type: string
        process_type:
          type: string
        mount_path:
          type: string
        read_only:
          type: boolean
          default: false
        created_at:
          type: string

    CreateVolumeAttachmentRequest:
      type: object
      required: [volume_id, process_type, mount_path]
      properties:
        volume_id:
          type: string
        process_type:
          type: string
        mount_path:
          type: string
        read_only:
          type: boolean
          default: false

    Snapshot:
      type: object
      required: [id, volume_id, created_at, status]
      properties:
        id:
          type: string
        volume_id:
          type: string
        created_at:
          type: string
        status:
          type: string
          enum: [queued, running, succeeded, failed]
        size_bytes:
          type: integer

    ListSnapshotsResponse:
      type: object
      required: [items, next_cursor]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Snapshot"
        next_cursor:
          type: [string, "null"]

    CreateSnapshotRequest:
      type: object
      properties:
        note:
          type: string

    RestoreVolumeRequest:
      type: object
      required: [snapshot_id]
      properties:
        snapshot_id:
          type: string
        new_volume_name:
          type: string

    LogLine:
      type: object
      required: [ts, line]
      properties:
        ts:
          type: string
        instance_id:
          type: string
        process_type:
          type: string
        line:
          type: string

    LogsResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/LogLine"

    ExecGrantRequest:
      type: object
      required: [command]
      properties:
        command:
          type: array
          items:
            type: string
        tty:
          type: boolean
          default: true

    ExecGrantResponse:
      type: object
      required: [session_id, connect_url, session_token, expires_in_seconds]
      properties:
        session_id:
          type: string
        connect_url:
          type: string
        session_token:
          type: string
        expires_in_seconds:
          type: integer

    Event:
      type: object
      required: [event_id, occurred_at, event_type]
      properties:
        event_id:
          type: integer
        occurred_at:
          type: string
        event_type:
          type: string
        aggregate_type:
          type: string
        aggregate_id:
          type: string
        aggregate_seq:
          type: integer
        actor_id:
          type: string
        payload:
          type: object
          additionalProperties: true
          description: Protobuf JSON mapping of the event payload when available.

    EventsResponse:
      type: object
      required: [items, next_after_event_id]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Event"
        next_after_event_id:
          type: integer
